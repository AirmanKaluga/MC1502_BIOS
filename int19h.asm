;---------------------------------------------------------------------------------------------------
; Прерывание 19h - "Теплая" перезагрузка (загрузка операционной системы)
;
; Назначение: Этот обработчик выполняет загрузку операционной системы с диска.
; Вызывается после завершения POST (Power-On Self Test) или программно
; для перезагрузки системы без полного самотестирования.
;
; Алгоритм работы:
;   1. Сброс дисковых систем
;   2. Попытка чтения загрузочного сектора (boot sector) с диска
;   3. Проверка сигнатуры загрузочного сектора (AA55h)
;   4. Передача управления коду загрузчика по адресу 0000:7C00h
;   5. При неудаче - вывод сообщения об ошибке и ожидание нажатия клавиши
;
; Особенности:
;   - Сначала пробует загрузиться с жесткого диска (80h), затем с дискеты (00h)
;   - Выполняет 3 попытки чтения загрузочного сектора
;   - Использует DMA-адрес 0000:7C00h (стандартное место для загрузочного сектора)
;   - Проверяет сигнатуру 55AAh в конце загрузочного сектора (смещение 1FEh)
;---------------------------------------------------------------------------------------------------
proc		int_19h
                ; Инициализация: ES = 0000h (сегмент для загрузки), DL = 80h (первый жесткий диск)
                xor	dx, dx 
                mov	es, dx
                mov	dl, 80h               ; Начинаем с жесткого диска (80h)

; ---------------------------------------------------------------------------
; Попытка чтения загрузочного сектора
; ---------------------------------------------------------------------------
read_boot_sector:				; ...
                mov	cx, 3                 ; Максимум 3 попытки чтения

; ---------------------------------------------------------------------------
; Цикл попыток чтения загрузочного сектора
; ---------------------------------------------------------------------------
read_boot_sector_loop:				; ...
                push	cx                   ; Сохраняем счетчик попыток
                
                ; Сброс дискового контроллера (функция 00h int 13h)
                mov	ah, dh               ; AH = 00h (функция сброса), DH = 00h
                int	13h                  ; Сброс дискового контроллера
                jb	short disk_system_error  ; Ошибка при сбросе
                
                ; Чтение загрузочного сектора (1 сектор) в память по адресу 0000:7C00h
                mov	bx, 7C00h            ; ES:BX = 0000:7C00h (стандартный адрес загрузочного сектора)
                mov	cx, 1                ; Сектор 1, дорожка 0 (CH=0, CL=1)
                mov	ax, 201h             ; AH=02h (читать сектора), AL=01h (1 сектор)
                int	13h                  ; Чтение загрузочного сектора
                
                pop	cx                   ; Восстанавливаем счетчик попыток
                jnb	short verify_boot_sector  ; Если чтение успешно, проверяем загрузочный сектор
                
                ; Ошибка чтения - повторяем попытку
                loop	read_boot_sector_loop    ; Уменьшаем CX и повторяем, если CX > 0
                
                ; Если все 3 попытки неудачны, переходим к обработке ошибки
                jmp	short disk_system_error

; ---------------------------------------------------------------------------
; Обработка ошибки дискового контроллера или чтения
; ---------------------------------------------------------------------------
disk_system_error:				; ...
                ; Пробуем другой диск: сдвигаем бит в DL (80h -> 00h -> ...)
                shl	dl, 1                ; Сдвиг влево: 80h -> 100h (с флагом переноса)
                jb	short read_boot_sector  ; Если был бит 7, теперь перенос установлен - переходим к чтению с другого диска
                
                ; Проверяем, не было ли уже сообщения "System not found"
                test	[byte ptr es:dsk_motor_stat_], 40h  ; Проверяем флаг в области данных BIOS
                jnz	short system_not_found_error  ; Если флаг установлен, выводим сообщение об ошибке
                
                ; Устанавливаем флаг, чтобы избежать повторного вывода сообщения
                or	[byte ptr es:dsk_motor_stat_], 40h
                jmp	short read_boot_sector  ; Пробуем еще раз

; ---------------------------------------------------------------------------
; Ошибка: система не найдена (не удалось загрузиться ни с одного диска)
; ---------------------------------------------------------------------------
system_not_found_error:				; ...
                ; Выводим сообщение "System not found."
                mov	si, offset SystemNotFound
                call	print_string
                sti                     ; Разрешаем прерывания
                
                ; Выводим сообщение с предложением вставить загрузочный диск
                mov	si, offset str_ins_disk   ; "Insert BOOT disk in A:"
                call	print_string            ; Выводим строку
                call	get_key                ; Ожидаем нажатия любой клавиши
                
                ; Очищаем экран и пытаемся загрузиться снова
                call	clear_screen
                call	int_19h                ; Рекурсивный вызов (теплый перезапуск)

; ---------------------------------------------------------------------------
; Проверка загрузочного сектора
; ---------------------------------------------------------------------------
verify_boot_sector:				; ...
                ; Проверяем сигнатуру загрузочного сектора (55AAh на конце 512-байтного сектора)
                cmp	[word ptr es:7DFEh], 0AA55h  ; 0AA55h в little-endian
                jnz	short disk_system_error      ; Если сигнатура неверна, считаем это ошибкой
                
                ; Сигнатура верна - передаем управление загрузчику
                jmpfar 0, 7C00h          ; Дальний переход на 0000:7C00h (код загрузочного сектора)

endp		int_19h
