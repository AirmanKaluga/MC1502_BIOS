;---------------------------------------------------------------------------------------------------
; Прерывание 05h - Печать содержимого экрана на принтер (Print Screen)
;
; Функция: Копирует текущее содержимое текстового экрана на принтер.
; Вызывается автоматически при нажатии комбинации клавиш Shift+PrtSc,
; а также может быть вызвано программно через int 05h.
;
; Алгоритм работы:
;   1. Проверяет флаг печати (по адресу 0050h:0000h) для избежания рекурсии
;   2. Определяет текущий видео режим и размеры экрана
;   3. Последовательно читает каждый символ с экрана и отправляет на принтер
;   4. В конце печатает перевод строки и восстанавливает курсор
;
; Особенности:
;   - Работает только в текстовых режимах (не печатает графику)
;   - Использует принтерный порт LPT1 (порт 0)
;   - Сохраняет позицию курсора до печати и восстанавливает после
;   - Если принтер не готов, устанавливает флаг ошибки (0050h:0000h = 0FFh)
;---------------------------------------------------------------------------------------------------
proc		int_05h	far				; Сервис печати экрана
                sti					; Разрешаем прерывания
                push	ds				; Сохраняем регистры
                push	ax
                push	bx
                push	cx
                push	dx
                
                ; Устанавливаем DS на сегмент 0050h (область флагов BIOS)
                mov	ax, 50h
                mov	ds, ax
                assume ds:nothing
                
                ; Проверяем флаг печати экрана (0050h:0000h)
                ; 0 = печать разрешена, 1 = печать в процессе, 0FFh = ошибка принтера
                cmp	[byte ptr ds:0], 1
                jz	short exit_print_screen	; Если уже идет печать, выходим
                
                ; Устанавливаем флаг "печать в процессе"
                mov	[byte ptr ds:0], 1
                
                ; Получаем текущий видео режим и размеры экрана
                mov	ah, 0Fh			; Функция 0Fh - получить текущий видео режим
                int	10h			; Вызов видео сервиса
                                        ; Возврат: AH = количество колонок, AL = видео режим, BH = активная страница
                
                ; Сохраняем размеры экрана:
                ; CL = количество колонок (ширина экрана)
                ; CH = количество строк (высота экрана) - 25 строк (19h)
                mov	cl, ah			; CL = ширина в символах
                mov	ch, 19h			; CH = 25 строк
                
                ; Печатаем перевод строки перед началом вывода
                call	print_cr_lf
                
                ; Сохраняем текущую позицию курсора
                push	cx			; Сохраняем размеры экрана в стеке
                mov	ah, 3			; Функция 03h - получить позицию курсора
                int	10h			; Вызов видео сервиса
                                        ; Возврат: DH = строка, DL = колонка, CH = начало курсора, CL = конец курсора
                pop	cx			; Восстанавливаем размеры экрана
                push	dx			; Сохраняем позицию курсора в стеке
                
                ; Начинаем печать с верхнего левого угла (строка 0, колонка 0)
                xor	dx, dx			; DH = 0 (строка), DL = 0 (колонка)

; ---------------------------------------------------------------------------
; Главный цикл печати: проход по всем строкам и колонкам экрана
; ---------------------------------------------------------------------------
print_screen_loop:				; ...
                ; Устанавливаем курсор в текущую позицию (DH=строка, DL=колонка)
                mov	ah, 2			; Функция 02h - установить позицию курсора
                int	10h			; Вызов видео сервиса
                
                ; Читаем символ и атрибут в текущей позиции курсора
                mov	ah, 8			; Функция 08h - прочитать символ и атрибут
                int	10h			; Вызов видео сервиса
                                        ; Возврат: AL = символ, AH = атрибут
                
                ; Проверяем, не является ли символ нулевым (пустым)
                or	al, al			; Символ = 0?
                jnz	short print_character	; Нет - печатаем как есть
                mov	al, 20h			; Да - заменяем на пробел (20h)

; ---------------------------------------------------------------------------
; Печать одного символа на принтер
; ---------------------------------------------------------------------------
print_character:				; ...
                ; Сохраняем текущие координаты (DH, DL) в стеке
                push	dx
                
                ; Отправляем символ на принтер (LPT1, порт 0)
                xor	dx, dx			; DX = 0 (порт LPT1)
                xor	ah, ah			; AH = 0 (функция печати символа)
                int	17h			; Вызов принтерного сервиса
                                        ; Возврат: AH = статус принтера
                
                ; Восстанавливаем координаты из стека
                pop	dx
                
                ; Проверяем статус принтера (биты 0,2,5 = ошибка, нет бумаги, таймаут)
                test	ah, 25h			; Проверяем биты: 0 (таймаут), 2 (ошибка в/вы), 5 (нет бумаги)
                jnz	short printer_error	; Если есть ошибка, переходим к обработке
                
                ; Переходим к следующей колонке в текущей строке
                inc	dl			; Увеличиваем номер колонки
                cmp	cl, dl			; Сравниваем с количеством колонок
                jnz	short print_screen_loop	; Если не достигли конца строки, продолжаем
                
                ; Достигли конца строки - переходим к следующей строке
                xor	dl, dl			; Сбрасываем колонку в 0
                mov	ah, dl			; AH = 0 (для функции печати символа)
                
                ; Печатаем перевод строки (CR+LF)
                push	dx			; Сохраняем позицию (строка DH, колонка 0)
                call	print_cr_lf		; Печатаем перевод строки на принтере
                pop	dx			; Восстанавливаем позицию
                
                ; Переходим к следующей строке
                inc	dh			; Увеличиваем номер строки
                cmp	ch, dh			; Сравниваем с количеством строк
                jnz	short print_screen_loop	; Если не достигли конца экрана, продолжаем
                
                ; Успешно распечатали весь экран
                ; Восстанавливаем исходную позицию курсора из стека
                pop	dx			; Восстанавливаем сохраненную позицию курсора
                mov	ah, 2			; Функция 02h - установить позицию курсора
                int	10h			; Восстанавливаем курсор
                
                ; Сбрасываем флаг печати (успешное завершение)
                mov	[byte ptr ds:0], 0
                jmp	short exit_print_screen

; ---------------------------------------------------------------------------
; Обработка ошибки принтера
; ---------------------------------------------------------------------------
printer_error:				; ...
                ; Восстанавливаем исходную позицию курсора из стека
                pop	dx			; Восстанавливаем сохраненную позицию курсора
                mov	ah, 2			; Функция 02h - установить позицию курсора
                int	10h			; Восстанавливаем курсор
                
                ; Устанавливаем флаг ошибки принтера (0FFh)
                mov	[byte ptr ds:0], 0FFh

; ---------------------------------------------------------------------------
; Выход из обработчика прерывания
; ---------------------------------------------------------------------------
exit_print_screen:				; ...
                pop	dx			; Восстанавливаем регистры
                pop	cx
                pop	bx
                pop	ax
                pop	ds
                assume ds:nothing
                iret				; Возврат из прерывания
endp		int_05h