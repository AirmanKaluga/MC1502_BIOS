;------------------------------------------------------------------------------------
; Прерывание 1Ah - Функции системного таймера (Software Timer)
;
; На IBM PC/XT и МС1502 нет аппаратных часов реального времени (RTC).
; Вместо этого используется программный счетчик на основе системного таймера,
; который обнуляется при каждой перезагрузке и требует ручной установки времени.
;
; Функции:
;   AH = 00h - Чтение текущего значения счетчика тиков таймера
;   AH = 01h - Установка значения счетчика тиков таймера
;
; Системный таймер увеличивается на 1 каждые ?55 мс (18.2 раза в секунду).
; Это соответствует частоте 18.2 Гц, которая генерируется каналом 0 таймера 8253/8254.
;
; Структура данных в BDA (область данных BIOS):
;   timer_low_    (адрес 06Ch) - младшее слово счетчика тиков
;   timer_hi_     (адрес 06Eh) - старшее слово счетчика тиков
;   timer_rolled_ (адрес 070h) - флаг переполнения (1 при достижении 24 часов)
;
; Важно: При выключении питания счетчик сбрасывается в 0.
; Для сохранения времени в МС1502 мог использоваться внешний модуль RTC
; или пользователь должен был вводить время при каждой загрузке.
;------------------------------------------------------------------------------------
proc 		int_1Ah near
                push	ds                      ; Сохраняем регистр DS
                push	ax                      ; Сохраняем AX (в AH функция)
                mov	ax, BDAseg              ; Загружаем сегмент BDA (040h)
                mov	ds, ax                  ; Устанавливаем DS на сегмент BDA
                assume ds:nothing
                pop	ax                      ; Восстанавливаем AX
                
                ; Проверяем запрошенную функцию по значению в AH
                or	ah, ah                  ; AH = 00h?
                jz	short read_timer_func   ; Да - чтение счетчика
                dec	ah                      ; AH = 01h?
                jz	short set_timer_func    ; Да - установка счетчика

; ---------------------------------------------------------------------------
; Выход из прерывания (для неизвестных функций или после выполнения)
; ---------------------------------------------------------------------------
exit_int_1a:				; ...
                pop	ds                      ; Восстанавливаем исходное значение DS
                assume ds:nothing
                iret                    ; Возврат из прерывания

; ---------------------------------------------------------------------------
; Функция 00h: Чтение текущего значения счетчика таймера
; Вход:   AH = 00h
; Выход:  CX = старшее слово счетчика (timer_hi_)
;         DX = младшее слово счетчика (timer_low_)
;         AL = флаг переполнения (timer_rolled_), сбрасывается в 0 после чтения
; ---------------------------------------------------------------------------
read_timer_func:				; ...
                ; Читаем флаг переполнения и сбрасываем его
                mov	al, [ds:timer_rolled_]     ; AL = значение флага переполнения
                mov	[byte ptr ds:timer_rolled_], 0 ; Сбрасываем флаг
                
                ; Читаем текущее значение счетчика тиков
                mov	cx, [ds:timer_hi_]         ; CX = старшая часть (часы)
                mov	dx, [ds:timer_low_]        ; DX = младшая часть (тики)
                
                jmp	short exit_int_1a          ; Выход из прерывания

; ---------------------------------------------------------------------------
; Функция 01h: Установка значения счетчика таймера
; Вход:   AH = 01h
;         CX = старшее слово счетчика (timer_hi_)
;         DX = младшее слово счетчика (timer_low_)
; Выход:  Счетчик установлен в указанное значение, флаг переполнения сброшен
; ---------------------------------------------------------------------------
set_timer_func:				; ...
                ; Устанавливаем новое значение счетчика тиков
                mov	[ds:timer_low_], dx        ; Младшая часть
                mov	[ds:timer_hi_], cx         ; Старшая часть
                
                ; Сбрасываем флаг переполнения
                mov	[byte ptr ds:timer_rolled_], 0
                
                jmp	short exit_int_1a          ; Выход из прерывания

endp		int_1Ah
